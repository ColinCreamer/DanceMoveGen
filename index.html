<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Dance Move Selector - v31.3</title>
    <style>
        /* Version 31 */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            cursor: pointer; /* Change cursor to pointer for clicking */
        }
        h1 {
            font-size: 36px;
        }
        #danceStyle {
            font-size: 40px;
            margin: 20px 0;
        }
        #danceMove {
            font-size: 48px;
            margin: 20px 0;
        }
        #role {
            font-size: 24px;
            margin: 10px 0;
        }
        #roleImage img {
            max-height: 250px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 0 10px);
        }
        #roleImage {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button {
            font-size: 20px;
            padding: 10px 20px;
            cursor: pointer;
        }
        select {
            width: 250px;
            height: auto;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 20px 0;
        }
        #progressBar {
            height: 20px;
            background-color: #4caf50;
            width: 0;
            border-radius: 5px;
            transition: width 0.3s;
        }
        #progressText {
            margin-top: 5px;
            font-size: 16px;
        }
    </style>
</head>
<body">

    <h1>Random Dance Move Selector - v31.3</h1>

    <label for="danceTypes">Select Dance Styles:</label><br>
    <select id="danceTypes" multiple size="6">
        <option value="Foxtrot">Foxtrot</option>
        <option value="Waltz">Waltz</option>
        <option value="Tango">Tango</option>
        <option value="Rhumba">Rhumba</option>
        <option value="Cha-Cha">Cha-Cha</option>
        <option value="East Coast Swing">East Coast Swing</option>
    </select><br><br>

    <label for="roles">Select Role:</label><br>
    <select id="roles">
        <option value="Both">Both</option>
        <option value="Lead">Lead</option>
        <option value="Follow">Follow</option>
    </select><br><br>

    <label>
        <input type="checkbox" id="cycleMoves"> Cycle through all selected moves
    </label><br>
    <label>
        <input type="checkbox" id="randomCycle"> Generate randomly within cycle
    </label><br><br>

    <button onclick="generateDanceMove(event)">Generate Dance Move</button>

    <div id="voiceToggle">
        <label for="voiceEnabled">Enable Voice:</label>
        <input type="checkbox" id="voiceEnabled">
    </div>


    <div id="danceStyle"></div>
    <div id="danceMove"></div>
    <div id="role"></div>
    <div id="roleImage"></div>

    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>
    <div id="progressText">0 / 0</div>

    <script>
        const danceMoves = {
            Foxtrot: [
                "Basic", "Outside Basic", "Promenade Basic", "Left Ad-lib", 
                "Right Ad-lib", "Side Rock Ad-lib", "CTB Closed Turning Basic", 
                "OTB Outside Turning Basic"
            ],
            Waltz: [
                "Basic Box (in place)", "Progressive", "Left 1/4 Turn", 
                "Right 1/4 Turn", "Left 3/8th Turn", "Right 3/8th Turn", 
                "4a. Forward and Back Balance Steps", "4b. Side Balance Steps", 
                "4c. 5th Position Balance Steps"
            ],
            Tango: [
                "Basic Step", "Outside Basic", "PTL - Promenade Basic Turning Left", 
                "PTR - Promenade Basic Turning Right", "Corte'", "Rocking Corte'"
            ],
            Rhumba: [
                "Basic Box Step", "Underarm Turn (Reg. 6 step)", 
                "Underarm Turn (Adv. 3 Step)", "Cross Body Lead", 
                "5th Position Breaks"
            ],
            "Cha-Cha": [
                "Basic", "Progressive Basic", "Single CrossOver Break", 
                "Double CrossOver Break", "Natural Underarm Turn", 
                "2-Way Underarm Turn"
            ],
            "East Coast Swing": [
                "Single Time Basic", "Double Time Basic", "Tripple Time Basic", 
                "Release Break", "Underarm Turn", "Underarm with Man Turning"
            ]
        };

        let completedMoves = new Set();
        let remainingMoves = [];
        const danceTypesSelect = document.getElementById("danceTypes");
        const rolesSelect = document.getElementById("roles");
        const cycleMovesCheckbox = document.getElementById("cycleMoves");
        const randomCycleCheckbox = document.getElementById("randomCycle");
		const enableVoiceCheckbox = document.getElementById("voiceEnabled");
        const danceStyleElement = document.getElementById("danceStyle");
        const danceMoveElement = document.getElementById("danceMove");
        const roleElement = document.getElementById("role");
        const roleImageElement = document.getElementById("roleImage");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");

        // Load saved settings from local storage
        window.onload = function() {
            const savedDanceTypes = localStorage.getItem('danceTypes');
            if (savedDanceTypes) {
                const danceTypesArray = savedDanceTypes.split(',');
                Array.from(danceTypesSelect.options).forEach(option => {
                    option.selected = danceTypesArray.includes(option.value);
                });
            }

            const savedRole = localStorage.getItem('role');
            if (savedRole) {
                rolesSelect.value = savedRole;
            }

            const cycleMovesSetting = localStorage.getItem('cycleMoves');
            cycleMovesCheckbox.checked = cycleMovesSetting === 'true';

            const randomCycleSetting = localStorage.getItem('randomCycle');
            randomCycleCheckbox.checked = randomCycleSetting === 'true';


            const enableVoiceSetting = localStorage.getItem('enableVoice');
            enableVoiceCheckbox.checked = enableVoiceSetting === 'true';




            updateProgressText();
        };

        danceTypesSelect.addEventListener('change', () => {
            resetMovesIfNeeded(); // Reset moves if styles are deselected
            updateProgressText();
            saveSettings();
        });

        rolesSelect.addEventListener('change', () => {
            resetMovesIfNeeded(); // Reset moves if role is changed
            updateProgressText();
            saveSettings();
        });

        cycleMovesCheckbox.addEventListener('change', saveSettings);
        randomCycleCheckbox.addEventListener('change', saveSettings);
		//enableVoiceCheckbox.addEventListener('change', saveSettings; );
		
		enableVoiceCheckbox.addEventListener('change', function() {
			if (!this.checked) {
				synth.cancel();
			}
			saveSettings();
		});


		
		// Add event listener for clicks on the body, excluding the buttons and UI elements
        document.body.addEventListener('click', function(event) {
            const ignoredElements = ['BUTTON', 'SELECT', 'OPTION', 'INPUT', 'LABEL'];
            if (!ignoredElements.includes(event.target.tagName)) {
                generateDanceMove();
            }
        });
		
		

        function generateDanceMove() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            if (selectedDanceTypes.length === 0) {
                alert("Please select at least one dance type.");
                return;
            }

            let danceType;
            let danceMove;
            let role;

            if (cycleMovesCheckbox.checked) {
                if (remainingMoves.length === 0) {
                    prepareMoveSet(selectedDanceTypes);
                }

                if (randomCycleCheckbox.checked) {
                    const randomIndex = Math.floor(Math.random() * remainingMoves.length);
                    ({ move: danceMove, type: danceType, role } = remainingMoves[randomIndex]);
                    remainingMoves.splice(randomIndex, 1);
                } else {
                    const nextMove = remainingMoves.shift();
                    danceMove = nextMove.move;
                    danceType = nextMove.type;
                    role = nextMove.role;
                }

                completedMoves.add(danceMove + " " + role);

                // Reset cycle and progress bar if all moves have been completed
                if (remainingMoves.length === 0) {
                    completedMoves.clear();
                    updateProgressBar(0, 0);
                }

            } else {
                danceType = selectedDanceTypes[Math.floor(Math.random() * selectedDanceTypes.length)];
                danceMove = danceMoves[danceType][Math.floor(Math.random() * danceMoves[danceType].length)];
                role = getRole();
                completedMoves.add(danceMove + " " + role);
            }

            danceStyleElement.textContent = danceType;
            danceMoveElement.textContent = danceMove;
            roleElement.textContent = role;
            roleImageElement.innerHTML = `
                <img src="${role === "Lead" ? 'LeadDancerSilhouette.png' : 'FollowDancerSilhouette.png'}" 
                style="height: 250px; filter: drop-shadow(0 0 10px ${role === "Lead" ? "blue" : "red"})">
            `;

            updateProgressText(); // Update the progress text after generating a move
			
			if (enableVoiceCheckbox.checked) {
                narrateMove(danceType, danceMove, role); // Call the voice narration function
            }
        }

        function getRole() {
            const selectedRole = rolesSelect.value;
            if (selectedRole === "Both") {
                return Math.random() < 0.5 ? "Lead" : "Follow";
            }
            return selectedRole;
        }

        function prepareMoveSet(selectedDanceTypes) {
            remainingMoves = [];
            selectedDanceTypes.forEach(type => {
                danceMoves[type].forEach(move => {
                    if (rolesSelect.value === "Lead") {
                        remainingMoves.push({ move, type, role: "Lead" });
                    } else if (rolesSelect.value === "Follow") {
                        remainingMoves.push({ move, type, role: "Follow" });
                    } else { // Both
                        remainingMoves.push({ move, type, role: "Lead" });
                        remainingMoves.push({ move, type, role: "Follow" });
                    }
                });
            });

            // Shuffle the moves if random cycling is enabled
            if (randomCycleCheckbox.checked) {
                remainingMoves = shuffleArray(remainingMoves);
            }
            updateProgressText(); // Update progress text after preparing the moves
        }


		let previousDanceTypeSelections = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);

        function resetMovesIfNeeded() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            const selectedRole = rolesSelect.value;

			// Check for deselection
			const deselected = previousDanceTypeSelections.filter(selection => !selectedDanceTypes.includes(selection));

			// Update previousDanceTypeSelections to the current ones for the next change event
			previousDanceTypeSelections = selectedDanceTypes;


            // Reset remaining moves and completed moves if switching from "Both" to a single role
            if (selectedRole !== "Both" || selectedDanceTypes.length === 0 || deselected.length > 0){
                completedMoves.clear();
                remainingMoves = [];
                updateProgressBar(0, 0);
				//rcc apmpt
				//if (cycleMovesCheckbox.checked) prepareMoveSet(selectedDanceTypes);
            }
			
			
			


			
        }

        function updateProgressText() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            const selectedRole = rolesSelect.value;

            let totalMoves = 0;
            if (selectedDanceTypes.length) {
                totalMoves = selectedDanceTypes.reduce((acc, type) => {
                    const movesCount = danceMoves[type].length;
                    if (selectedRole === 'Lead' || selectedRole === 'Follow') {
                        return acc + movesCount; // Only count one role's set of moves
                    } else {
                        return acc + (movesCount * 2); // Count both roles' moves
                    }
                }, 0);
            }

            const completed = completedMoves.size;
            updateProgressBar(completed, totalMoves);

            // Reset progress if no styles or roles selected
            if (totalMoves === 0 || selectedRole === "") {
                completedMoves.clear(); // Reset the completed moves
                remainingMoves = []; // Reset remaining moves
                updateProgressBar(0, totalMoves);
            }
        }

        function updateProgressBar(completed, total) {
            progressBar.style.width = total === 0 ? "0%" : (completed / total * 100) + "%";
            progressText.textContent = `${completed} / ${total}`;
        }

        function saveSettings() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            localStorage.setItem('danceTypes', selectedDanceTypes.join(','));
            localStorage.setItem('role', rolesSelect.value);
            localStorage.setItem('cycleMoves', cycleMovesCheckbox.checked);
            localStorage.setItem('randomCycle', randomCycleCheckbox.checked);
			localStorage.setItem('enableVoice', enableVoiceCheckbox.checked);
			
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
		
		
		const synth = window.speechSynthesis;
		
		// Web Speech API function to narrate the move
        function narrateMove(danceType, danceMove, role) {
		
			synth.cancel();
		
			const removedDanceMoveNumber = danceMove.replace("4a.",'').replace("4b.",'').replace("4c.",'').replace("Reg. ",'Regular').replace("Adv. ",'Advanced ');
		
            const message = `${danceType} ${removedDanceMoveNumber} - ${role}.`;
            const utterance = new SpeechSynthesisUtterance(message);
			utterance.rate=1.5;
            speechSynthesis.speak(utterance);
        }
		
    </script>
</body>
</html>
