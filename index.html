<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Dance Move Selector - v35</title>
    <style>
        /* Version 35 */
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            cursor: pointer; /* Change cursor to pointer for clicking */
        }
        h1 {
            font-size: 36px;
        }
        #danceStyle {
            font-size: 40px;
            margin: 20px 0;
        }
        #danceMove {
            font-size: 48px;
            margin: 20px 0;
        }
        #role {
            font-size: 24px;
            margin: 10px 0;
        }
        #roleImage img {
            max-height: 250px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 0 10px);
        }
        #roleImage {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button {
            font-size: 20px;
            padding: 10px 20px;
            cursor: pointer;
        }
        select {
            width: 250px;
            height: auto;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin: 20px 0;
        }
        #progressBar {
            height: 20px;
            background-color: #4caf50;
            width: 0;
            border-radius: 5px;
            transition: width 0.3s;
        }
        #progressText {
            margin-top: 5px;
            font-size: 16px;
        }
		
		#randomCycleLabel{
			visibility: hidden;	/* Initially hidden */ 
		}
		
		
		 #autoDrillSettings {
            margin-top: 20px;
            display: none; /* Initially hidden */
        }
        #autoDrillSlider {
            width: 200px;
        }
        #sliderValue {
            font-size: 18px;
        }
		#autoDrillPauseToggle{
			margin: 0px;
			padding: 2px;
			text-align: center;
		}
		
		
		.smallBtn{
			padding: 2px;
			text-align: center;
		}
		
		#musicControlSettings {
            margin-top: 20px;
            display: none; /* Initially hidden */
			
			/*display: flex;*/
			align-items: center;
			justify-content: center;
			gap: 10px; /* Add space between elements */
			
        }

		#bpmRangeSlider{
			width : 300px;
			margin:10px;
			/*align-items: center;*/
		}


		#helpButton {
			display: block;
			margin: 10px auto;
			padding: 5px 10px;
			background-color: #007bff;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
		}

		#helpButton:hover {
			background-color: #0056b3;
		}

		#helpDisplay {
			margin: 10px auto;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 5px;
			background-color: #f9f9f9;
			display: none;
		}

		#helpDisplay.visible {
			display: block;
		}

		
    </style>
	
	<!--noUiSlider-->
	<!-- Gives us a multi point ranged slider-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.css" integrity="sha512-MKxcSu/LDtbIYHBNAWUQwfB3iVoG9xeMCm32QV5hZ/9lFaQZJVaXfz9aFa0IZExWzCpm7OWvp9zq9gVip/nLMg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.8.1/nouislider.min.js" integrity="sha512-g/feAizmeiVKSwvfW0Xk3ZHZqv5Zs8PEXEBKzL15pM0SevEvoX8eJ4yFWbqakvRj7vtw1Q97bLzEpG2IVWX0Mg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	
	
</head>
<body>

    <h1>Random Dance Move Selector - v35</h1>

    <label for="danceTypes">Select Dance Styles:</label><br>
    <select id="danceTypes" multiple size="6">
        <option value="Foxtrot">Foxtrot</option>
        <option value="Waltz">Waltz</option>
        <option value="Tango">Tango</option>
        <option value="Rhumba">Rhumba</option>
        <option value="Cha-Cha">Cha-Cha</option>
        <option value="East Coast Swing">East Coast Swing</option>
		<option value="Mambo">Mambo</option>
		<option value="Samba">Samba</option>
    </select><br><br>

    <label for="roles">Select Role:</label><br>
    <select id="roles">
        <option value="None">Don't Specifty</option>
        <option value="Lead">Lead</option>
        <option value="Follow">Follow</option>
		<option value="Both">Both</option>
    </select><br><br>

    <label title="Cycle though all of the avaialble moves once before repeating">
        <input type="checkbox" id="cycleMoves" > Cycle All Moves
    </label>
	
    <label id="randomCycleLabel" title="Cycle though moves in a random order">
		<input type="checkbox" id="randomCycle"> Random Order
	</label>
	
	
	<br><br>
	
	<hr>
	<label>
        <input type="checkbox" id="autoDrillCheckbox">Auto Drill Mode
    </label>
	
    <div id="autoDrillSettings">
        <label for="autoDrillSlider">Auto Drill Interval:</label><br>
        <input type="range" id="autoDrillSlider" min="1" max="60" value="5">
        <span id="sliderValue">5</span> seconds
		<br>
		<button id="autoDrillPauseToggle" title="Pause/Resume Drill Timmer">‚è∏</button>
		<span id="autoDrillSecondsLeft">5</span>s <i>untill next move</i>
		
    </div><br>

	<hr>
	
	



    <div id="voiceToggle">
		<input type="checkbox" id="voiceEnabled">
        <label for="voiceEnabled">Narrate Dance Moves:</label>
    </div>
	
	<div id="voiceCommandControl" title="Use your voice to execute commands. Valid commands: Next, Play Music, Stop Music, Help">
		<label>
			<input type="checkbox" id="voiceCommandCheckbox" >
			Enable Voice Commands üé§
		</label>
	</div>
	
	<div title="Clap for next dance move.">
		<label>
			<input type="checkbox" id="clapDetectionCheckbox">
			Enable Clap Detection
		</label>
	</div>	
	
	<label>
		<input type="checkbox" id="rhythmCountCheckbox" />
		Narrate Count/Rhythm
	</label>
	
	
	<input type="range" id="rhythmCountBpmSlider" min="60" max="230" value="100">
	<label for="rhythmCountBpmSlider">BPM:</label>
	<span id="rhythmCountBpmSliderValue">100</span>
	<label><input type="checkbox" id="repeatCountCheckbox"/>loop</label>
	<label><input type="checkbox" id="measureCountingCheckbox"/>Measures</label>
	
	<br>
	<hr>
	
	<label>
	<input type="checkbox" id="playMusicCheckbox" />
		Play music
	</label>
	
	<div id="musicControlSettings">
		<br><br><br>
		<button id="musicPauseButton" title="Pause/Resume Music Track" class="smallBtn" onclick="toggleMusicPause()">‚è∏</button>
		<button onclick="playNextSong()" title="Skip to next Music Track"  class="smallBtn" alt="Next">‚è≠</button>
		<label for="bpmRangeSlider" title="BPM Range Filter. Only songs that are within the BPM tempo range will be played if avaialble.">BPM: </label>
		<div id="bpmRangeSlider"></div>
		<span id="bpmRangeDisplay">60 - 230 BPM</span>
		
	</div>
	
	<br>
	<hr>
	<br>
	
	<div id="currentSongTitle"></div>
	<br>
	<button onclick="generateDanceMove(event)">Generate Dance Move</button>
	<br>
	

	<br>
    <div id="danceStyle"></div>
    <div id="danceMove"></div>
    <div id="role"></div>
    <div id="roleImage"></div>
	
	
	<button id="helpButton">Help</button>
	<div id="helpDisplay" class="hidden"></div>

    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>
    <div id="progressText">0 / 0</div>

    <script>


		
		const danceMoves = {
			Foxtrot: [
				{ index: 1.1, name: "Basic", 						rhythm: "SSQQ" },
				{ index: 1.2, name: "Promenade Basic", 				rhythm: "SSQQ" },
				{ index: 3.1, name: "Left Ad-lib", 					rhythm: "SSQQ;SSQQ" },
				{ index: 3.2, name: "Right Ad-lib", 				rhythm: "SSQQ;SSQQ" },
				{ index: 3.3, name: "Side Rock Ad-lib", 			rhythm: "SSQQ;SSQQ" },
				{ index: 2.1, name: "CTB Closed Turning Basic", 	rhythm: "SSQQ;SSQQ" },
				{ index: 2.2, name: "OTB Outside Turning Basic", 	rhythm: "SSQQ;SSQQ" },
				{ index: 4, name: "Cross Body Lead", 				rhythm: "SSQQ&;SSQQ&" },
				{ index: 5, name: "Single Twinkle", 				rhythm: "SQQ" },
				
				//Sosial Ease
				{index: -105, name: "Forward Crosses", 				rhythm: "SSQQ;SQQ;SQQ;SQQ;SQQ", elements: "2 Prominade Walks; March-March (turn 180 Right), 1 Walk forward; March-March (turn 180 Left), 1 Walk forward; March-March (turn 180 Right), 1 Walk forward; Scoop Pick up follow and do Prominad Basic to close" }
				
			],
			Waltz: [
				{ index: 0,   name: "Basic Box (in place)", 			rhythm: "123;123" },
				{ index: 2,   name: "Progressive", 						rhythm: "123;123" },
				{ index: 1.1, name: "Left 1/4 Turn", 					rhythm: "123;123;123;123" },
				{ index: 3.1, name: "Right 1/4 Turn", 					rhythm: "123;123;123;123;123;123" },
				{ index: 1.2, name: "Left 3/8th Turn", 					rhythm: "123;123" },
				{ index: 3.2, name: "Right 3/8th Turn", 				rhythm: "123;123;123;123" },
				{ index: 4.1, name: "Forward and Back Balance Steps", 	rhythm: "123;123" },
				{ index: 4.2, name: "Side Balance Steps", 				rhythm: "123;123" },
				{ index: 4.3, name: "5th Position Balance Steps", 		rhythm: "123;123" },
				{ index: 5, name: "Cross Body Lead", 					rhythm: "123;123;" },
				
				//Sosial Ease
				
				{ index: -104.1, name: "Underarm Turns (6 Walks)", 			rhythm: "123;123;123;123"},
				{ index: -104.2, name: "Underarm Turns (Reverse Turn)", 	rhythm: "123;123;123;123"},
				{ index: -104.3, name: "Underarm Turns (Man Turn)", 	rhythm: "123;123;123;123"},
				
				{ index: -105.1, name: "Run Around", 					rhythm: "123;123;123;?Q&Q&Q&Q&Q&Q&?", elements: "Basic Box 1st half; Basic Box 2nd half while leading 1st half of 6-step underarm turn; Basic Box 1st half while leading 2nd half of 6-step underarm turn; Grab Follows Elbow, and run quickly spining in a circle as much as you want. " },
				{ index: -105.2, name: "Walk Around", 					rhythm: "123;123;123;123;123;123", elements: "Basic Box 1st half; Basic Box 2nd half while leading 1st half of 6-step underarm turn; Basic Box 1st half while leading 2nd half of 6-step underarm turn; Grab Follows Elbow, Walk in circle; Walk in circle; Natural Turn and close" },
				{ index: -105.3, name: "Walk Around (Reverse Turn End)", rhythm: "123;123;123;123;123;123", elements: "Basic Box 1st half; Basic Box 2nd half while leading 1st half of 6-step underarm turn; Basic Box 1st half while leading 2nd half of 6-step underarm turn; Grab Follows Elbow, Walk in circle; Walk in circle; Reverse Turn and close" },
			],
			Tango: [
				{ index: 1.1, name: "Basic Step", 							rhythm: "SSQQS" },
				{ index: 1.2, name: "Outside Basic", 						rhythm: "SSQQS" },
				{ index: 2.1, name: "Promenade Basic Turning Left - PTL", 	rhythm: "SSQQS" },
				{ index: 2.2, name: "Promenade Basic Turning Right - PTR", 	rhythm: "SSQQS;SSQQS" },
				{ index: 3.1, name: "Cort√©", 								rhythm: "SSQQS" },
				{ index: 3.2, name: "Rocking Cort√©", 						rhythm: "QQSS;QQSS;QQS" },
				{ index: 4.1, name: "Right Side Fan", 						rhythm: "QQSS;QQSS;QQS" },
				{ index: 4.2, name: "Three Fan Combination", 				rhythm: "QQSS;SSQQ;QQS" },
				{ index: 5, name: "Running Step",							rhythm: "SSQQ;SSQQ;QQS" },
				
				//Sosial Ease
				{ index: -101.1, name: "Pont√© A",									rhythm: "SS;QQQQ;SS;QQQQ",		footPos:"55;1111;35;2121",		elements: "2 Prominade Walks; 4 closed Steps; Pont√©, Cross Step Back; Side Step, Closed Step, Side Step, Closed Step"},
				{ index: -101.2, name: "Pont√© B (1 turn)",							rhythm: "SS;QQQQ;SS;QQQQ",		footPos:"55;1111;35;2121",		elements: "2 Prominade Walks; (4 closed Steps) while Follow turning Right; Pont√©, Cross Step Back; Side Step, Closed Step, Side Step, Closed Step"},
				{ index: -101.3, name: "Pont√© C (2 turns)",							rhythm: "SS;QQQQ;SS;QQQQ",		footPos:"55;1111;35;2121",		elements: "2 Prominade Walks; (4 closed Steps) while Follow turning Right; Pont√©, Cross Step Back; (Side Step, Closed Step, Side Step, Closed Step) while Follow turning Left"},
				{ index: -101.4, name: "Pont√© D (PTR Rocking turn)",				rhythm: "SS;QQQQ;SS;QQQQ",		footPos:"55;4444;35;2121",		elements: "First 2 Steps of PTR; 4 right rock Turn Steps; Pont√©, Cross Step Back; Side Step, Closed Step, Side Step, Closed Step"},
				{ index: -101.5, name: "Pont√© D2 (PTL Rocking turn)",				rhythm: "SS;QQQQ;SS;QQQQ",		footPos:"5[4/5];4444;35;2121",		elements: "First 2 Steps of PTL; 4 Left rock Turn Steps; Pont√©, Cross Step Back; Side Step, Closed Step, Side Step, Closed Step"},	//[4/5] = Lead 4 / Follow 5
				
				{ index: -102.1, name: "Open Fan A",								rhythm: "SS;QQS;S&S&;QQS",		footPos:"55;233;5353;421",			elements: "2 Prominade Walks; (March, March) while Rotate 1/4 right, Pont√© towards Eachother; Step Forward, Pont√©, Cross Step, Pont√©; Tango Close"},
				{ index: -102.2, name: "Open Fan B (With Pont√© Arm Styles)",		rhythm: "SS;QQS;S&S&;QQS",		footPos:"55;233;5353;421",			elements: "2 Prominade Walks; (March, March) while Rotate 1/4 right, Pont√© towards Eachother; Step Forward, Pont√©, Cross Step, Pont√©; Tango Close"},
				{ index: -102.2, name: "Open Fan C (With Flicks)",					rhythm: "SS;QQS;QQQQ;S&S&;QQS",	footPos:"55;233;3333;5353;421",		elements: "2 Prominade Walks; (March, March) while Rotate 1/4 right, Pont√© towards Eachother; 2 Flicks ; Step Forward, Pont√©, Cross Step, Pont√©; Tango Close"},
				{ index: -102.2, name: "Open Fan D (Fans in middle)",				rhythm: "SS;QQS;S&S&;QQS",	    footPos:"55;?213;4141;421",	/*? not sure if foot pos is 21, 23 or 33*/	elements: "2 Prominade Walks; (March, March) while sending her out 180 with J-Lead, Pont√© towards Eachother; Forward Step, Fan (both),Forward Step, Fan (Follow)/Closed(Lead); Tango Close"},
			],
			Rhumba: [
				{ index: 1.1, name: "Basic Box Step", 					rhythm: "QQS;QQS" },
				{ index: 2.1, name: "Underarm Turn (Reg. 6 step)", 		rhythm: "QQS;QQS;QQS;QQS" },
				{ index: 2.2, name: "Underarm Turn (Adv. 3 Step)", 		rhythm: "QQS;QQS;QQS;QQS" },
				{ index: 1.2, name: "Cross Body Lead", 					rhythm: "QQS;QQS;QQS;QQS" },
				{ index: 3, name: "5th Position Breaks", 				rhythm: "QQS;QQS;QQS;QQS;QQS;QQS" },
				{ index: 4, name: "Open Cuban Walk", 					rhythm: "QQS;QQS;QQS;QQS;QQS;QQS;QQS;QQS" },
				{ index: 5.1, name: "Forward Rock Steps", 				rhythm: "QQS;QQS;QQS;QQS" },
				{ index: 5.2, name: "Left Turning Rock", 				rhythm: "QQS;QQS;QQS;QQS" }
			],
			"Cha-Cha": [
				{ index: 1.1, name: "Basic", 							rhythm: "1234&;1234&" },
				{ index: 1.2, name: "Progressive Basic", 				rhythm: "1234&;1234&" },
				{ index: 2.1, name: "Single CrossOver Break", 			rhythm: "1234&;1234&;1234&;1234&" },
				{ index: 2.2, name: "Double CrossOver Break", 			rhythm: "1234&;1234;12&;3412;34&;1234&" },
				{ index: 3.1, name: "Natural Underarm Turn", 			rhythm: "1234&;1234&;1234&;1234&" },
				{ index: 3.2, name: "Two-Way Underarm Turn", 			rhythm: "123;4&1;23;4&1;23;4&1;234&" },
				{ index: 4.1, name: "Chase Turns", 						rhythm: "1234&;1234&;1234&;1234&;1234&;1234&" },
				{ index: 4.2, name: "Cross Over Chase", 				rhythm: "1234&;1234&;1234&;1234&;1234&;1234&" },
				{ index: 5, name: "Cross Triple Step", 					rhythm: "123;4&1;2&3;4&1;23;4&1;2&3:4&1:23;4&1234&" }
			],
			"East Coast Swing": [
				{ index: 1.1, name: "Single Time Basic", 				rhythm: "SSQQ" },
				{ index: 1.2, name: "Double Time Basic", 				rhythm: "12,34,56" },
				{ index: 1.3, name: "Triple Time Basic", 				rhythm: "1&2,3&4,56" },
				{ index: 2, name: "Release Break", 						rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56" },
				{ index: 3.1, name: "Underarm Turns", 					rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56" },
				{ index: 3.2, name: "Underarm with Man Turning", 		rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56" },
				{ index: 4,	name: "Egg Beater", 						rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;" },
				{ index: 5.1, name: "Single Tuck-In Turn", 				rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;" },
				{ index: 5.2, name: "Double Tuck-In Turn", 				rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;" },
				{ index: 5.3, name: "Shoulder Spin Tuck-In", 			rhythm: "1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;1&2,3&4,56;" }
			],
			"Mambo": [//On2
				{ index: 1.1, name: "Box Step", 						rhythm: "1234;1234" ,	footPos: "2442;2442", elements: "Hold, Forward Rockstep, Side Step; Back Rockstep, Side Step"},
				{ index: 1.2, name: "Progressive Basic", 				rhythm: "1234;1234" ,	footPos: "444;444", elements: "Hold, Forward Rockstep, Back Step; Back Rockstep, Forward Step"},
				{ index: 2, name: "Cross Body Lead", 					rhythm: "1234;1234" ,	footPos: "443;4442", elements: "Hold, Forward Rockstep, Side Step 3rd; Back Rockstep, Side Step"},
				{ index: 3.1, name: "Forward & Backward Break Steps", 	rhythm: "1234;1234" ,	footPos: "1441;1441", elements: "Hold, Forward Rockstep, Close; Back Rockstep, Close"},
				{ index: 3.2, name: "Side Breaks Without Turn", 		rhythm: "1234;1234" ,	footPos: "1441;1441", elements: "Hold, Side Rockstep, Close; Side Rockstep, Close"},
				{ index: 3.2, name: "Side Breaks With Turn", 			rhythm: "1234;1234;1234;1234" ,	footPos: "1441;1441", elements: "Hold, Side Rockstep, turn 90 to Close; Side Break Rockstep, Turn 180 Close;  Side Break Rockstep, Turn 180 Close;  Side Break Rockstep, Turn 90 Close;"},
				{ index: 3.3, name: "Shine Forward Break Steps", 		rhythm: "1234;1234;1234;1234;1234;1234" ,	footPos: "444;444;42;42;444;444", elements: "Hold, Progressive Basic; Press Step, Press Step, Progressive Basic"},
				{ index: 4.1, name: "Natural Underarm Turn", 			rhythm: "1234;1234;1234;1234", 				elements: "Crossbody Lead, Open Break, 4th Position Rock Step while lead follows Natural Turn"},
				{ index: 4.2, name: "Reverse Underarm Turn", 			rhythm: "1234;1234;1234;1234", 				elements: "Basic Box Step, 5th Position Break, 2nd Half of Cross Body Lead but last step forward instead of side"},
				{ index: 5.1, name: "Full Chase Turn", 					rhythm: "1234;1234;1234;1234;1234;1234", 	elements: "Progressive Basic, Full Chase Turn (Millitary turn + Fan = 360), 2nd half Progressive Basic, Progressive Basic"},
				{ index: 5.1, name: "Chase Turn (half)", 				rhythm: "1234;1234;1234;1234;1234;1234", 	elements: "Progressive Basic, Half Chase Turn (Walk Forward, Millitary turn), Half Chase Turn (Walk Forward, Millitary turn), Progressive Basic"}
			],
			"Samba": [
				{ index: 1.1, name: "Basic", 						rhythm: "1&2;1&2",	footPos: "41;41", elements: "Forward Ballance Step; Back Ballance Step"}, 
				{ index: 1.2, name: "Left Box Turn", 			rhythm: "1&2;1&2",	footPos: "42;42", elements: "Forward Ballance Step to side; Back Ballance Step to side" },
				{ index: 2.1, name: "Fifth Position Breaks", 	rhythm: "1&2;1&2",	footPos: "255;255", elements: "" },
				{ index: 2.2, name: "Progressive Fifth Position Breaks", 	rhythm: "1&2;1&2",	footPos: "M[422;422] F[455;455]", elements: "M[Forward, Side Rock; Forward, Side Rock ] F[Back/Side, 5th Position; Back/Side, 5th Postion" },
				{ index: 3, name: "Promenade Conversa", 	rhythm: "1&2;1&2",	footPos: "255;255;555;555;555;555;555;521", elements: "Fifth Position Break; Fifth Position Break, Conversa x5; 2nd half twinkel (Cross, Side, Together)" },
				{ index: 4.1, name: "Single Chasse", 	rhythm: "1&2;1&2",	footPos: "21;21", elements: "Side, Close; Side, Close.  (holla-hoop hips)" },
				{ index: 4.2, name: "Triple Chasse", 	rhythm: "",	footPos: "", elements: "" },
				{ index: 4.3, name: "Travelling Chasse", 	rhythm: "",	footPos: "", elements: "" },
				{ index: 5, name: "Left Cross Turn", 	rhythm: "",	footPos: "", elements: "" }
			]
		};

		


		//used https://www.beatsperminuteonline.com/ to manauly time the BPMs for the songs by tapping the beat/count with a button
		
		let musicList = {
		  "Waltz": [
			{
			  "title": "Tales From Vienna Woods",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F01.01.%20Tales%20From%20Vienna%20Woods.mp3"
			  ,"startTime": 3.717
			  ,"bpm": 200 //87, 66  (Beat counter 174)tap180-200
			  ,"year": 1868
			},
			{
			  "title": "Blue Danube",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F01.02.%20Blue%20Danube.mp3"
				,"startTime": 1.676
				,"bpm": 200//68 //99 //tap 199
				,"year": 1867
			},
			{
			  "title": "Artists Life",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F01.03.%20Artists%20Life.mp3"
				,"startTime": 2.089
				,"bpm": 190//66 //Tap190
				,"year": 1867
			},
			{
			  "title": "Acceleration Waltz",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F01.04.%20Acceleration%20Waltz.mp3"
				,"startTime": 1.181
				,"bpm": 214//112 //Tap214
				,"year": 1860
			},
			{
			  "title": "Wine, Women And Song",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F01.05.%20Wine%2C%20Women%20And%20Song.mp3"
				,"startTime": 3.22
				,"bpm": 180//106 //Tap180
				,"year": 1869
			},
			{
			  "title": "Voices Of Spring",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F02.01.%20Voices%20Of%20Spring.mp3"
				,"startTime": 3.951
				,"bpm": 209//69 tap209
				,"year": 1882
			},
			{
			  "title": "Die Fliedermause (The Bat)",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F02.03.%20Die%20Fliedermause%20%28The%20Bat%29.mp3"
				,"startTime": 2.902
				,"bpm": '180-220' //tap 188-220
				,"year": 1874
			},
			{
			  "title": "Emperor Waltz",
			  "url": "https://archive.org/download/lp_original-johann-strauss-waltzes_johann-strauss-jr-the-danube-strings_0/disc1%2F02.04.%20Emperor%20Waltz.mp3"
				,"startTime": 2.972
				,"bpm": '150-220' //tap 150-220
				,"year": 1889 
			},
			{
			  "title": "Honolulu Moon (Luna Honolulu)",
			  "url": "https://archive.org/download/78_honolulu-moon-luna-honolulu_society-night-club-orchestra-fred-lawrence_gbia0096071a/Honolulu%20Moon%20%28Luna%20Honolulu%29%20-%20Society%20Night%20Club%20Orchestra.mp3"
				,"startTime": 4.45
				,"bpm": 130 //tap 130-137
				,"year": 1926
			},
			{
			  "title": "The One Rose",
			  "url": "https://archive.org/download/78_the-one-rose_jay-balls-kona-hawaiians_gbia0000300a/The%20One%20Rose%20-%20Jay%20Ball%27s%20Kona%20Hawaiians.mp3"
				,"startTime": 3.59
				,"bpm": 90 //tap 90
				,"year": 1936
			},
			{	//very quiet volume
			  "title": "YOU'RE IN LOVE",
			  "url": "https://ia601307.us.archive.org/28/items/78_youre-in-love_lou-preager-his-orchestra-paul-rich-de-murcia-penrose-kerbel_gbia3029982a/YOU%27RE%20IN%20LOVE%20-%20LOU%20PREAGER%20%26%20HIS%20ORCHESTRA.mp3"
				,"startTime": 5.245
				,"bpm": 101 //tap 
			},
			{	
			  "title": "WALTZ MEDLEY-SLOW SIDE",
			  "url": "https://archive.org/download/78_waltz-medley-slow-side_ivor-moreton-and-dave-kaye_gbia3040580a/WALTZ%20MEDLEY-SLOW%20SIDE%20-%20IVOR%20MORETON%20and%20DAVE%20KAYE.mp3"
				,"startTime": 4.838
				,"bpm": 112 //tap 
				,"year": 1953
			},
			{	
			  "title": "WALTZ MEDLEY-FAST SIDE",
			  "url": "https://archive.org/download/78_waltz-medley-fast-side_ivor-moreton-and-dave-kaye_gbia3040580b/WALTZ%20MEDLEY-FAST%20SIDE%20-%20IVOR%20MORETON%20and%20DAVE%20KAYE.mp3"
				,"startTime": 4.693
				,"bpm": 180 //tap 
				,"year": 1953
			},
			{	
			  "title": "Chop Sticks",
			  "url": "https://archive.org/download/78_chop-sticks_gbia0437172b/CHOP%20STICKS.mp3"
				,"startTime": 2.847
				,"bpm": 130 //tap 
				,"year": 1877
			},
			{	
			  "title": "LOLITA (Zwei weisse Moeven)",
			  "url": "https://archive.org/download/78_lolita-zwei-weisse-moeven_peter-hansen-zeissner-spiller-hubert_gbia3027807a/LOLITA%20%28Zwei%20weisse%20Moeven%29%20-%20PETER%20HANSEN.mp3"
				,"startTime": 2.318
				,"bpm": 100 //tap 
				,"year": 1955
			},
			{	
			  "title": "Kukavica Waltz 1379-6",
			  "url": "https://archive.org/download/78_kukavica-waltz/1379-6.mp3"
				,"startTime": 0.102
				,"bpm": 145 //tap
				,"year": 1945
			}



			
			
		  ],
		  "Tango": [
			{
			  "title": "Por Una Cabeza",
			  "url": "https://archive.org/download/CarlosGardelPorUnaCabeza/Carlos-Gardel-Por-una-cabeza.mp3"
				,"startTime": 0.18
				,"bpm": 120//60 //tap 120
				,"year": 1935
			},
			{
			  "title": "El Malevo",
			  "url": "https://archive.org/download/78_el-malevo_kramer-e-i-suoi-solisti-j-de-caro_gbia3020658a/EL%20MALEVO%20-%20KRAMER%20E%20I%20SUOI%20SOLISTI%20-%20J.%20De%20Caro.mp3"
				,"startTime": 5.657
				,"bpm": 111 //tap109
				//,"year": "unknown"
			},
			{
			  "title": "Gelosia",
			  "url": "https://archive.org/download/78_gelosia_kramer-e-i-suoi-solisti-gade_gbia3020661a/GELOSIA%20-%20KRAMER%20E%20I%20SUOI%20SOLISTI%20-%20Gade.mp3"
				,"startTime": 4.571
				,"bpm": 115 //tap117
				,"year": 1925
			},
			{
			  "title": "Tango of Love",
			  "url": "https://archive.org/download/78_tango-of-love_henri-ren-and-his-tango-orchestra-td-e-costello_gbia0328138a/TANGO%20OF%20LOVE%20-%20HENRI%20REN%C3%89%20and%20his%20Tango%20Orchestra.mp3"
				,"startTime": 3.103
				,"bpm": 115 //tap115
				,"year": 1945
			},
			{
			  "title": "Busc√°ndote",
			  "url": "https://archive.org/download/Elkintangohomework/Busc%C3%A1ndote%20-%20Osvaldo%20Fresedo%20&%20Ricardo%20Ruiz%20-%20Tango.mp3"
				,"startTime": 1.125
				,"bpm": 123   //tap125
				,"year": 1941
			},
			{
			  "title": "El Acomodo",
			  "url": "https://archive.org/download/Elkintangohomework/06%20Edgardo%20Donato%20-%20El%20Acomodo.mp3"
				,"startTime": 0.212
				,"bpm": 133 //tap135
				,"year": 1933
			},
			{
			  "title": "Al comp√°s del coraz√≥n",
			  "url": "https://archive.org/download/Elkintangohomework/09%20Al%20comp%C3%A1s%20del%20coraz%C3%B3n%20-%20Miguel%20Cal%C3%B3%20c.%20Ra%C3%BAl%20Ber%C3%B3n%20(1942).mp3"
				,"startTime": 0.419
				,"bpm": 119 //tap123
				,"year": 1942
			}
			
			
			
			
		  ],
		  "Rhumba": [
			{
			  "title": "Cuatro Personas",
			  "url": "https://archive.org/download/78_cuban-rhythms_hotel-nacional-orchestra-beltran_gbia0002479/Cuatro%20Personas%20-%20Hotel%20Nacional%20Orchestra-restored.mp3"
				,"startTime": 0.33
				,"bpm": 185 //tap185
				,"year": 1945
			},
			{
			  "title": "Dulce Desengano",
			  "url": "https://archive.org/download/78_cuban-rhythms_hotel-nacional-orchestra-beltran_gbia0002479/Dulce%20Desengano%20-%20Hotel%20Nacional%20Orchestra-restored.mp3"
				,"startTime": 0.399
				,"bpm": 145 //tap145
			}
		  ],
		  "Foxtrot": [
			{
			  "title": "Singing in the Rain",
			  "url": "https://archive.org/download/78_let-a-smile-be-your-umbrella-on-a-rainy-day_murray-kellner-freed-brown_gbia0095027/01%20-%20Singing%20in%20the%20Rain%20-%20Murray%20Kellner%20-%20Freed.mp3"
				,"startTime": 2.808
				,"bpm": 153 //tap153
				,"year": 1929
			},
			{
			  "title": "Rain",
			  "url": "https://archive.org/download/78_let-a-smile-be-your-umbrella-on-a-rainy-day_murray-kellner-freed-brown_gbia0095027/03%20-%20Rain%20-%20Murray%20Kellner%20-%20Eugene%20Ford.mp3"
				,"startTime": 3.337
				,"bpm": 125 //tap125
			},
			{
			  "title": "That Get It, Mr. Joe",
			  "url": "https://archive.org/download/78_that-get-it-mr-joe_fats-waller-and-his-rhythm-fats-waller-james-p-johnson_gbia0100455a/That%20get%20it%2C%20Mr.%20Joe%20-%20%22Fats%22%20Waller%20and%20his%20Rhythm.mp3"
				,"startTime": 3.516
				,"bpm": 175 //tap
				,"year": 1941
			},
			{
			  "title": "Hot Spot Blues",
			  "url": "https://archive.org/download/78_hot-spot-blues_leo-mathisens-orkester-leo-mathisen-erik-parker_gbia7025555a/HOT%20SPOT%20BLUES%20-%20LEO%20MATHISENS%20ORKESTER%20-%20Leo%20Mathisen%20%26%20Erik%20Parker.mp3"
				,"startTime": 4.067
				,"bpm": 165 //tap
			},
			{
			  "title": "Stormy Weather",
			  "url": "https://archive.org/download/78_stormy-weather_leo-mathisens-band-helge-jacobsen-koehler-arlen_gbia7026217a/STORMY%20WEATHER%20-%20LEO%20MATHISEN%27S%20BAND%20-%20HELGE%20JACOBSEN.mp3"
				,"startTime": 4.767
				,"bpm": 95 //tap
				,"year": 1933 
			},
			{
			  "title": "BLUE ORCHIDS",
			  "url": "https://archive.org/download/78_blue-orchids_victor-silvester-his-ballroom-orchestra-carmichael_gbia3002095b/BLUE%20ORCHIDS%20-%20VICTOR%20SILVESTER%20%26%20HIS%20BALLROOM%20ORCHESTRA.mp3"
				,"startTime": 3.212
				,"bpm": 93 //tap93
				,"year": 1939 
			}
			
			
		  ],
		  "Cha-Cha": [
			{
			  "title": "Baila Mi Chacha Cha",
			  "url": "https://archive.org/download/78_baila-mi-chacha-cha_tito-puente-and-his-orchestra-e-duarte_gbia0101009b/Baila%20Mi%20Chacha%20Cha%20-%20Tito%20Puente%20and%20His%20Orchestra.mp3"
				,"startTime": 4.153
				,"bpm": 126 //tap
			},
			{
			  "title": "Dansero",
			  "url": "https://archive.org/download/lp_mambo_perez-prado-and-his-orchestra-tito-rodr/disc1%2F01.02.%20Dansero.mp3"
				,"startTime": 2.133
				,"bpm": 132 //tap
			},
			{
			  "title": "Azuquito Con Leche",
			  "url": "https://archive.org/download/lp_mambo_perez-prado-and-his-orchestra-tito-rodr/disc1%2F01.03.%20Azuquito%20Con%20Leche.mp3"
				,"startTime": 2.312
				,"bpm": 142 //tap
			},
			{
			  "title": "Harvest Moon Cha Cha",
			  "url": "https://archive.org/download/lp_cha-cha-festival_perez-prado-and-his-orchestra-pepito-pavon/disc1%2F01.03.%20Harvest%20Moon%20Cha%20Cha.mp3"
				,"startTime": 2.493
				,"bpm": 138 //tap
			}
		  ],
		  "East Coast Swing": [
			{
			  "title": "A String Of Pearls",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F01.01.%20A%20String%20Of%20Pearls%20%28Glenn%20Miller%20Version%29.mp3"
				,"startTime": 3.047
				,"bpm": 155 //tap
				,"year": 1941
			},
			{
			  "title": "Don't Sit Under The Apple Tree",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F01.02.%20Don%27t%20Sit%20Under%20The%20Apple%20Tree%20%28Glenn%20Miller%20Version%29.mp3"
				,"startTime": 1.952
				,"bpm": 185 //tap
				,"year": 1942
			},
			{
			  "title": "Swing Low, Sweet Chariot",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F01.04.%20Swing%20Low%2C%20Sweet%20Chariot%20%28Tommy%20Dorsey%20Version%29.mp3"
				,"startTime": 1.514
				,"bpm": 134 //tap
			},
			{
			  "title": "Flying Home",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F01.05.%20Flying%20Home%20%28Lionel%20Hampton%20Version%29.mp3"
				,"startTime": 2.119
				,"bpm": 185 //tap
				,"year": 1942
			},
			{
			  "title": "Jersey Bounce",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F02.01.%20Jersey%20Bounce%20%28Benny%20Goodman%20Version%29.mp3"
				,"startTime": 2.442
				,"bpm": 130 //tap
				,"year": 1942	
			},
			{
			  "title": "Basie Boogie",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F02.03.%20Basie%20Boogie%20%28Count%20Basie%20Version%29.mp3"
				,"startTime": 1.345
				,"bpm": 173 //tap
				
			},
			{
			  "title": "Charleston Alley",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F02.04.%20Charleston%20Alley%20%28Charley%20Barnet%20Version%29.mp3"
				,"startTime": 2.278
				,"bpm": 156 //tap			
			},
			{
			  "title": "Air Mail Special",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc1%2F02.05.%20Air%20Mail%20Special%20%28Benny%20Goodman%20Version%29.mp3"
				,"startTime": 2.219
				,"bpm": 230 //tap
				,"year": 1941	
			},
			{
			  "title": "9:20 Special",
			  "url": "https://archive.org/download/lp_the-swing-era-the-music-of-1941-1942-sw_various_0/disc2%2F03.01.%209%3A20%20Special%20%28Count%20Basie%20Version%29.mp3"
				,"startTime": 1.822
				,"bpm": 194 //tap
			}
		  ]
		}
		
		
				/*
		let musicList = {};
		fetch('MusicList.json')
		  .then(response => response.json())
		  .then(data => {
			musicList = data;
		  })
		  .catch(error => console.error('Error loading music list:', error));
		*/
		
		
		const danceStyleCounts = {
			"Waltz": 3,
			"Swing": 6
			// Other dance styles with specific counts can be added here if needed
		};
		

        let completedMoves = new Set();
        let remainingMoves = [];
		let autoDrillIntervalId = null;
		let autoDrillPaused = false;
        let timeRemaining = 0;
		
		let currentSong = null;
		let currentSongDanceType = null;
		let musicAudio = new Audio();
		
		
		
		
        const danceTypesSelect = document.getElementById("danceTypes");
        const rolesSelect = document.getElementById("roles");
        const cycleMovesCheckbox = document.getElementById("cycleMoves");
        const randomCycleCheckbox = document.getElementById("randomCycle");
		const randomCycleLabel = document.getElementById("randomCycleLabel");
		const enableVoiceCheckbox = document.getElementById("voiceEnabled");
        const danceStyleElement = document.getElementById("danceStyle");
        const danceMoveElement = document.getElementById("danceMove");
        const roleElement = document.getElementById("role");
        const roleImageElement = document.getElementById("roleImage");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
		const autoDrillCheckbox = document.getElementById("autoDrillCheckbox");
        const autoDrillSlider = document.getElementById("autoDrillSlider");
        const sliderValueDisplay = document.getElementById("sliderValue");
		const autoDrillSettings = document.getElementById("autoDrillSettings");
		const autoDrillPauseToggle = document.getElementById("autoDrillPauseToggle");
		const autoDrillSecondsLeft = document.getElementById("autoDrillSecondsLeft");
		const playMusicCheckbox = document.getElementById("playMusicCheckbox");
		const rhythmCountCheckbox = document.getElementById("rhythmCountCheckbox");
		const rhythmCountBpmSlider = document.getElementById("rhythmCountBpmSlider");
		const rhythmCountBpmSliderDisplay = document.getElementById("rhythmCountBpmSliderValue");
		const repeatCountCheckbox = document.getElementById("repeatCountCheckbox");
		const measureCountingCheckbox = document.getElementById("measureCountingCheckbox");
		const helpButton = document.getElementById("helpButton");
		const helpDisplay = document.getElementById("helpDisplay");



		
		const currentSongTitle = document.getElementById("currentSongTitle");
		const musicPauseButton = document.getElementById('musicPauseButton');
		const musicControlSettings = document.getElementById('musicControlSettings');




        // Load saved settings from local storage
        window.onload = function() {
            const savedDanceTypes = localStorage.getItem('danceTypes');
            if (savedDanceTypes) {
                const danceTypesArray = savedDanceTypes.split(',');
                Array.from(danceTypesSelect.options).forEach(option => {
                    option.selected = danceTypesArray.includes(option.value);
                });
            }

            const savedRole = localStorage.getItem('role');
            if (savedRole) {
                rolesSelect.value = savedRole;
            }

            const cycleMovesSetting = localStorage.getItem('cycleMoves');
            cycleMovesCheckbox.checked = cycleMovesSetting === 'true';
			randomCycleLabel.style.visibility = cycleMovesCheckbox.checked ? "show" : "hidden"

            const randomCycleSetting = localStorage.getItem('randomCycle');
            randomCycleCheckbox.checked = randomCycleSetting === 'true';


            const enableVoiceSetting = localStorage.getItem('enableVoice');
            enableVoiceCheckbox.checked = enableVoiceSetting === 'true';

			const autoDrillSetting = localStorage.getItem('autoDrill');
            autoDrillCheckbox.checked = autoDrillSetting === 'true';

            const autoDrillSliderSetting = localStorage.getItem('autoDrillSlider');
            autoDrillSlider.value = autoDrillSliderSetting || 5;
            sliderValueDisplay.textContent = autoDrillSlider.value;
			autoDrillSecondsLeft.textContent = autoDrillSlider.value;
			
			//const playMusicSetting = localStorage.getItem('playMusic');
            //playMusicCheckbox.checked = playMusicSetting === 'true';
			
			const rhythmCountSetting = localStorage.getItem('rhythmCount');
            rhythmCountCheckbox.checked = rhythmCountSetting === 'true';
			
			const rhythmCountBpmSetting = localStorage.getItem('rhythmCountBpm');
            rhythmCountBpmSlider.value = rhythmCountBpmSetting || 100;
			rhythmCountBpmSliderDisplay.textContent = rhythmCountBpmSlider.value;


			const repeatCountSetting = localStorage.getItem('repeatCount');
            repeatCountCheckbox.checked = repeatCountSetting === 'true';
			
			const measureCountingSetting = localStorage.getItem('measureCounting');
            measureCountingCheckbox.checked = measureCountingSetting === 'true';



            toggleAutoDrillSettings();


            updateProgressText();
			

			
        };
		
		
		function saveSettings() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            localStorage.setItem('danceTypes', selectedDanceTypes.join(','));
            localStorage.setItem('role', rolesSelect.value);
            localStorage.setItem('cycleMoves', cycleMovesCheckbox.checked);
            localStorage.setItem('randomCycle', randomCycleCheckbox.checked);
			localStorage.setItem('enableVoice', enableVoiceCheckbox.checked);
			
			localStorage.setItem('autoDrill', autoDrillCheckbox.checked);
			localStorage.setItem('autoDrillSlider', autoDrillSlider.value);
			localStorage.setItem('playMusic', playMusicCheckbox.checked);
			
			localStorage.setItem('rhythmCount', rhythmCountCheckbox.checked);
			localStorage.setItem('rhythmCountBpm', rhythmCountBpmSlider.value);
			
        }
		
		
		//------UI Event Listeners---------------
		
		

        danceTypesSelect.addEventListener('change', () => {
            resetMovesIfNeeded(); // Reset moves if styles are deselected
            //updateProgressText();
            saveSettings();
        });

        rolesSelect.addEventListener('change', () => {
		
			editMoveSetRoles(); //modifys remaining moves to the new desired roles
		
            //resetMovesIfNeeded(); // Reset moves if role is changed
            //updateProgressText();
            saveSettings();
        });

        cycleMovesCheckbox.addEventListener('change', function() {
			randomCycleLabel.style.visibility = this.checked ? "visible" : "hidden"
			saveSettings();
		});
		
		
		
        randomCycleCheckbox.addEventListener('change', saveSettings);
		
		enableVoiceCheckbox.addEventListener('change', function() {
			if (!this.checked) {
				synth.cancel();
			}
			saveSettings();
		});

		playMusicCheckbox.addEventListener('change', function () {
			const danceType = currentSongDanceType;
			if (this.checked) {
				playMusic(danceType);
				musicControlSettings.style.display = 'flex'; //show   'block'
			} else {
				musicAudio.pause();
				currentSongTitle.textContent = '';
				musicControlSettings.style.display = 'none';//hide
				currentSong = null;
			}
			saveSettings();
		});



		function toggleAutoDrillSettings() {
			if (autoDrillCheckbox.checked) {
				autoDrillSettings.style.display = 'block';
				startAutoDrill();
			} else {
				autoDrillSettings.style.display = 'none';
				stopAutoDrill();
			}
			saveSettings();
		}

		autoDrillCheckbox.addEventListener('change', toggleAutoDrillSettings);

		autoDrillSlider.addEventListener('input', function() {
			sliderValueDisplay.textContent = autoDrillSlider.value;
			timeRemaining = autoDrillSlider.value;
			if (autoDrillCheckbox.checked) {
				stopAutoDrill();
				startAutoDrill();
			}
			saveSettings();
		});

        autoDrillPauseToggle.addEventListener('click', function() {
            autoDrillPaused = !autoDrillPaused;
            autoDrillPauseToggle.textContent = autoDrillPaused ? '‚èµ' : '‚è∏';
            if (autoDrillPaused) {
                clearInterval(autoDrillIntervalId);
            } else {
                startAutoDrill();
            }
        });


		rhythmCountCheckbox.addEventListener('change', function() {
			if (!rhythmCountCheckbox.checked){
				stopRythemCountAnnouncements();
			}
			saveSettings();
		});

		rhythmCountBpmSlider.addEventListener('input', function() {
			rhythmCountBpmSliderDisplay.textContent =  rhythmCountBpmSlider.value;
			saveSettings();
		});


		repeatCountCheckbox.addEventListener('change', function() {
		
			if(repeatCountCheckbox.checked){
				console.log("repeatCountCheckbox");
				if(danceStyleElement.textContent != "" && currentDanceMove){
					startRythmCountIfNotRunning(currentDanceMove.rhythm ,rhythmCountBpmSlider.value);
				}
			}
		
		
			//Save setting
			localStorage.setItem('repeatCount', repeatCountCheckbox.checked);
		});
		measureCountingCheckbox.addEventListener('change', function() {
			//Save setting
			localStorage.setItem('measureCounting', measureCountingCheckbox.checked);
		});



		helpButton.addEventListener("click", () => {
			// Format the active dance move data
			let moveDetails = ""; 
			
			if (currentDanceMove.rhythm) moveDetails+= "<strong>Rhythm:</strong> " + currentDanceMove.rhythm + " <br>";
			if (currentDanceMove.footPos) moveDetails+= "<strong>Foot Positions:</strong> " + currentDanceMove.footPos+ " <br>";
			if (currentDanceMove.elements) moveDetails+= "<strong>Elements:</strong> " + currentDanceMove.elements + " <br>";

			// Toggle visibility and populate the help display
			helpDisplay.innerHTML = moveDetails;
			helpDisplay.classList.toggle("visible");
		});



		function startAutoDrill() {
            if (!autoDrillPaused) {
			//1 second count down interaval timer loop
                autoDrillIntervalId = setInterval(() => {
				
				timeRemaining --;
				
				if (timeRemaining <= 0){
				    generateDanceMove();
				}
				autoDrillSecondsLeft.textContent = timeRemaining;

                }, 1000);
            }
        }


		function stopAutoDrill() {
			if (autoDrillIntervalId !== null) {
				clearInterval(autoDrillIntervalId);
				autoDrillIntervalId = null;
			}
		}



		
		// Add event listener for clicks on the body, excluding the buttons and UI elements
        document.body.addEventListener('click', function(event) {
            const ignoredElements = ['BUTTON', 'SELECT', 'OPTION', 'INPUT', 'LABEL', "#bpmRangeSlider"];
            if (!ignoredElements.includes(event.target.tagName) &&
				!bpmRangeSlider.contains(event.target) // Ignore clicks inside the noUiSlider div
			) {
				if (!autoDrillCheckbox.checked) {
					generateDanceMove();
				}
            }
        });
		
		
		

		let currentDanceMove;
		

        function generateDanceMove() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            if (selectedDanceTypes.length === 0) {
                alert("Please select at least one dance type.");
                return;
            }

            let danceType;
            let danceMove;
            let role;


            if (cycleMovesCheckbox.checked) {
                if (remainingMoves.length === 0) {
                    prepareMoveSet(selectedDanceTypes);
                }

                if (randomCycleCheckbox.checked) {
                    const randomIndex = Math.floor(Math.random() * remainingMoves.length);
                    ({ move: danceMove, type: danceType, role } = remainingMoves[randomIndex]);
                    remainingMoves.splice(randomIndex, 1);
                } else {
                    const nextMove = remainingMoves.shift();
                    danceMove = nextMove.move;
                    danceType = nextMove.type;
                    role = nextMove.role;
                }
				
                completedMoves.add(danceMove.name + " " + role);

			   // Reset cycle and progress bar if all moves have been completed
                if (remainingMoves.length === 0) {
                    completedMoves.clear();
                    updateProgressBar(0, 0);
                }


            } else {
                danceType = selectedDanceTypes[Math.floor(Math.random() * selectedDanceTypes.length)];
                danceMove = danceMoves[danceType][Math.floor(Math.random() * danceMoves[danceType].length)];
                role = getRole();
                completedMoves.add(danceMove.name + " " + role);
				
            }
			
			currentDanceMove = danceMove;

			

            danceStyleElement.textContent = danceType;
            danceMoveElement.textContent = floatToNumLetterFormat(danceMove.index) + " " + danceMove.name;
            roleElement.textContent = role;
			roleImageElement.innerHTML = `
				<img src="${role === "Lead" ? 'LeadDancerSilhouette.png' : role === "Follow" ? 'FollowDancerSilhouette.png' : 'DancersSilhouette.png'}" 
				style="height: 250px; filter: drop-shadow(0 0 10px ${role === "Lead" ? "blue" : role === "Follow" ? "red" : "yellow"})">
			`;

			//Reset Auto Drill Timmer
			timeRemaining = autoDrillSlider.value;
			autoDrillSecondsLeft.textContent = timeRemaining;


            updateProgressText(); // Update the progress text after generating a move
			
			if (enableVoiceCheckbox.checked) {
                narrateMove(danceType, danceMove, role); // Call the voice narration function
            }
			
			// Check if music should be played
			if (playMusicCheckbox.checked) {
				playMusic(danceType);
			}
			
			// Hide the help display when a new move is generated
			helpDisplay.classList.remove("visible");
			
        }
		
		//Converts a decimal Index stored in the move dataset, into the Syllabus format
		//(Converts 1.1 to 1B.)
		function floatToNumLetterFormat(num) {
			let [whole, decimal] = num.toString().split(".");  	// Split into integer and decimal parts
			whole = parseInt(whole);							// Parse the integer part
			decimal = parseInt(decimal || "0");					// Parse the decimal part, default to 0 if undefined

			let prefix = "";

			// Check if in -100s range for "Social" prefix
			if (whole <= -100 && whole > -200) {
				whole = Math.abs(whole % 100); // Get positive tens value only
				prefix = "Social";// add "Social" prefix
				//return `Social ${whole}${decimalToLetter(decimal)}.`; // Format with "Social" prefix
			}
				
			return `${prefix} ${whole}${decimalToLetter(decimal)}.`; 
		}

		// Helper function to convert decimal part to letter
		function decimalToLetter(decimal) {
			return ["", "a", "b", "c", "d", "e", "f", "g", "h", "i"][decimal] || "";
		}
		
		
		
		/*
		function floatToNumLetterFormat(num) {

			let [whole, decimal] = num.toString().split("."); // Split into integer and decimal parts
			whole = parseInt(whole); // Parse the integer part
			decimal = parseInt(decimal || "0"); // Parse the decimal part, default to 0 if undefined

			// Convert decimal part to letter format
			let suffix = "";
			if (decimal === 1) suffix = "a";
			else if (decimal === 2) suffix = "b";
			else if (decimal === 3) suffix = "c";
			else if (decimal === 4) suffix = "d";
			else if (decimal === 5) suffix = "e";
			else if (decimal === 6) suffix = "f";
			else if (decimal === 7) suffix = "g";
			else if (decimal === 8) suffix = "h";
			else if (decimal === 9) suffix = "i";

			return `${whole}${suffix}.`; // Format as required
		}
	
		*/
		
		//counts the number of beats in a dance move rhythm string
		//Slows = 2 beats, Quicks = 1 beat, digits = 1 beat
		function countMoveBeats(rhythm) {
			let beats = 0;

			for (let char of rhythm) {
			if (char === 'S') {
				beats += 2;  // Slow counts as 2 beats
			} else if (char === 'Q') {
				beats += 1;  // Quick counts as 1 beat
			} else if (!isNaN(char)) {
				beats += 1;  // Each digit counts as 1 beat
			}
			}

			return beats;
		}

		

        function getRole() {
            const selectedRole = rolesSelect.value;
            if (selectedRole === "Both") {
                return Math.random() < 0.5 ? "Lead" : "Follow";
            }else if (selectedRole === "None") {
				return "";
			}
            return selectedRole;
        }

        function prepareMoveSet(selectedDanceTypes) {
            remainingMoves = [];
            selectedDanceTypes.forEach(type => {
                danceMoves[type].forEach(move => {
                    if (rolesSelect.value === "Lead") {
                        remainingMoves.push({ move, type, role: "Lead" });
                    } else if (rolesSelect.value === "Follow") {
                        remainingMoves.push({ move, type, role: "Follow" });
					} else if (rolesSelect.value === "None") {
                        remainingMoves.push({ move, type, role: "" });
                    } else { // Both
                        remainingMoves.push({ move, type, role: "Lead" });
                        remainingMoves.push({ move, type, role: "Follow" });
                    }
                });
            });

            // Shuffle the moves if random cycling is enabled
            if (randomCycleCheckbox.checked) {
                remainingMoves = shuffleArray(remainingMoves);
            }
            updateProgressText(); // Update progress text after preparing the moves
        }


		function editMoveSetRoles() {
			const newRole = rolesSelect.value; // Get the new role
			const uniqueMoves = {}; // Object to track unique moves by move and type

			remainingMoves.forEach(item => {
				const key = `${item.move}-${item.type}`; // Create a unique key based on move and type

				// Only process the item if it hasn't been added yet
				if (!uniqueMoves[key]) {
					// Modify the role based on the newRole value
					if (newRole === "Lead") {
						if (item.role === "Lead" || item.role === "") {
							uniqueMoves[key] = { move: item.move, type: item.type, role: "Lead" };
						}
					} else if (newRole === "Follow") {
						if (item.role === "Follow" || item.role === "") {
							uniqueMoves[key] = { move: item.move, type: item.type, role: "Follow" };
						}
					} else if (newRole === "None") {
						uniqueMoves[key] = { move: item.move, type: item.type, role: "" };
					} else if (newRole === "Both") {
						// Add both roles for each unique move and type
						uniqueMoves[key] = { move: item.move, type: item.type, role: "Lead" };
						uniqueMoves[`${item.move}-${item.type}-follow`] = { move: item.move, type: item.type, role: "Follow" };
					}
				}
			});

			// Convert the uniqueMoves object back into an array
			remainingMoves = Object.values(uniqueMoves);

			// Optionally, shuffle the moves if needed
			if (randomCycleCheckbox.checked) {
				remainingMoves = shuffleArray(remainingMoves);
			}

			updateProgressText(); // Update progress text after editing the moves
		}




		let previousDanceTypeSelections = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);

        function resetMovesIfNeeded() {
            const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
            const selectedRole = rolesSelect.value;

			// Check for deselection
			const deselected = previousDanceTypeSelections.filter(selection => !selectedDanceTypes.includes(selection));

			// Update previousDanceTypeSelections to the current ones for the next change event
			previousDanceTypeSelections = selectedDanceTypes;


            // Reset remaining moves and completed moves if switching from "Both" to a single role
            if (selectedDanceTypes.length === 0 || deselected.length > 0){
				completedMoves.clear();
                remainingMoves = [];
            }
			
			updateProgressText();
			
			
        }

        function updateProgressText() {
		
			const completed = completedMoves.size;
			let totalMoves = completed + remainingMoves.length;	//Simple get total from move cycle arrays if avaiable.
		
			//More involved counting of total moves, based on avaiable moves and role selection. 
			if (totalMoves == 0 || remainingMoves.length == 0){
				const selectedDanceTypes = Array.from(danceTypesSelect.selectedOptions).map(option => option.value);
				const selectedRole = rolesSelect.value;

				if (selectedDanceTypes.length) {
					totalMoves = selectedDanceTypes.reduce((acc, type) => {
						const movesCount = danceMoves[type].length;
						if (selectedRole === 'Lead' || selectedRole === 'Follow' || selectedRole === 'None') {
							return acc + movesCount; // Only count one role's set of moves
						} else {
							return acc + (movesCount * 2); // Count both roles' moves
						}
					}, 0);
				}
			}
			 
			updateProgressBar(completed, totalMoves);

        }

        function updateProgressBar(completed, total) {
            progressBar.style.width = total === 0 ? "0%" : (completed / total * 100) + "%";
            progressText.textContent = `${completed} / ${total}`;
        }



        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
		
		
		
		// Web Speech API setup
        const synth = window.speechSynthesis;
        let femaleVoice, maleVoice;
        synth.onvoiceschanged = () => {
            const voices = synth.getVoices();
            femaleVoice = voices.find(voice => voice.name.includes('Female'));
            maleVoice = voices.find(voice => voice.name.includes('Male'));
        };
		
		
		// Web Speech API function to narrate the move
        function narrateMove(danceType, danceMove, role) {
		
			synth.cancel();					//Cancel Prwevoius Move Speach Narations
			stopRythemCountAnnouncements();	//Cancel previous Rythem Counts
		
			const danceMoveSpeachTweeked = danceMove.name.replace("Reg. ",'Regular').replace("Adv. ",'Advanced ');
		
            const message = `${danceType} ${danceMoveSpeachTweeked} - ${role}.`;
            const utterance = new SpeechSynthesisUtterance(message);
			utterance.voice = role === 'Follow' ? femaleVoice : maleVoice;
			utterance.rate=1.3;
            speechSynthesis.speak(utterance);
			
			const bpmSetting = rhythmCountBpmSlider.value;
			utterance.onend = () => {
				if (rhythmCountCheckbox.checked) {
					announceRhythmWithAudio(danceMove.rhythm, bpmSetting);
				}
			};
			
        }
		
		
		
		// Preload audio clips
		const audioClips = {};
		const clipNames = ["Slow", "Quick", "And", "1_high", "1_low", "2_high", "2_low", "3_high", "3_low", "4_high", "4_low", "5_high", "5_low", "6_high", "6_low", "7_high", "7_low", "8_high", "8_low", "9_high", "9_low"];
		clipNames.forEach(name => {
			audioClips[name] = new Audio(`CountClips/${name}.mp3`);
			
		});


	function timeUntilNextOne(beatsPerBar, firstOneTime, currentTime, bpm) {
		const msPerBeat = 60000 / bpm; // Milliseconds per beat based on BPM
		const barDuration = msPerBeat * beatsPerBar; // Total duration of one bar in milliseconds

		// Calculate time since the last "1" count
		const timeSinceFirstOne = currentTime - firstOneTime;

		// Calculate how far we are within the current bar
		const timeWithinBar = timeSinceFirstOne % barDuration;

		// Calculate time remaining until the next "1" count
		const timeUntilNextOne = barDuration - timeWithinBar;

		return timeUntilNextOne;
	}




		let scheduledRythemClipTimeouts = [];  // Array to keep track of scheduled timeouts

		function stopRythemCountAnnouncements(){
			// Clear any existing scheduled timeouts to prevent overlap
			scheduledRythemClipTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
			scheduledRythemClipTimeouts = [];  // Reset the array for new timeouts
		}

		function startRythmCountIfNotRunning(rhythmString, bpm){
		//console.log(rhythmString,scheduledRythemClipTimeouts.length)
			if (scheduledRythemClipTimeouts.length == 0 && rhythmString != ""){
				announceRhythmWithAudio(rhythmString, bpm);
			}
		}


		// Function to announce rhythm using preloaded audio clips
		function announceRhythmWithAudio(rhythmString, bpm) {
			
			stopRythemCountAnnouncements(); // Stop any ongoing rhythm count announcements
			
			//console.log("WEEE");
			
			const rhythmArray = rhythmString.split('').filter(char => /[SQ&1-9]/.test(char));
			const beatsPerMillisecond = 60000 / bpm;
			let currentTime = 0;

			// Determine the count for the current dance style
			const currentDanceStyleCount = danceStyleCounts[currentSongDanceType] || 4;  //3count,4count or 6count

			//If music is playing, calcualte the delay we need to wait before counting, in order to start on the 1
			if (musicAudio && !musicAudio.paused && !musicAudio.ended){
				//Calculate the delay till ONE
				const delayForNextOneCount = timeUntilNextOne(currentDanceStyleCount,currentSong.startTime,musicAudio.currentTime,currentSong.bpm);
				//Add it to the accumulative time var for setting the time-out delays for the counting Audio
				currentTime += delayForNextOneCount;
			}
			

			

			let currentCount = 0;
			let currentMeasure = 1;


			rhythmArray.forEach((char, index) => {
				// Determine the duration for each rhythm character based on its type
				let duration;
				let clipKey; // Audio clip key in `audioClips` object
				
			
				
				//Looks ahead to see if there is an & count after this one, if there is we cant to make room for it at the end of this count
				let subtractNextAnd = 0;
				/* //Edit, not liking how rushed it makes the & with this
				if (index + 1 <= rhythmArray.length && rhythmArray[index + 1] === '&'){
					subtractNextAnd = 0.2;
				}
				*/

				if (char === 'S') {
					duration = (2 - subtractNextAnd) * beatsPerMillisecond;
					currentCount+=2;
					clipKey = 'Slow';
				} else if (char === 'Q') {
					duration = (1 - subtractNextAnd) * beatsPerMillisecond;
					currentCount+=1;
					clipKey = 'Quick';
				} else if (char === '&') {
					duration = 0.5 * beatsPerMillisecond;
					clipKey = 'And';
					//This will position the "&" audio clip to play at the end of the previous beat wich we cleared space for above
					if (index > 0 ) {
						currentTime -= 0.5 * beatsPerMillisecond; // Reduce previous time for half-beat overlap
					}
				} else {
					duration = (1 - subtractNextAnd) * beatsPerMillisecond; // Digits are 1 beat
					currentCount+=1;
					if (char == 1){
						clipKey = `${char}_high`;
					}else{
						clipKey = `${char}_low`;
					}
				}
				
				
				//Overwrite ONE with measure
				if (measureCountingCheckbox.checked && char == '1') {
				
					clipKey = `${currentMeasure}_high`;
				
				}
				
				
				
				//Completed a measure, reset count and incrment measure
				if (currentCount == currentDanceStyleCount){
					currentMeasure+=1;
					currentCount = 0;
				}






				// Get the clip and calculate if its duration exceeds the allocated duration
				const clip = audioClips[clipKey];
				const clipDuration = clip ? clip.duration * 1000 : 0; // Clip duration in milliseconds
				let adjustedSpeed = 1;

				if (clipDuration > duration) {
					// Speed up the clip if its natural duration is longer than the allocated duration
					adjustedSpeed = clipDuration/duration;
					console.log("adjustedSpeed", adjustedSpeed)
				}


				// Schedule the audio clip to play at the calculated time
				 const timeoutId = setTimeout(() => {
					if (clip) {
						clip.currentTime = 0; // Reset playback position
						clip.playbackRate = adjustedSpeed; // Adjust speed to fit duration
						clip.play();
					}
				}, currentTime);

				// Add the timeout ID to the scheduledRythemClipTimeouts array
				scheduledRythemClipTimeouts.push(timeoutId);



				// Update cumulative time for the next clip
				currentTime += duration;
			});
			
			
			if (currentTime > 0){
				 // If `repeatCountCheckbox` is checked, schedule another round of counting after the full rhythm cycle
				const timeoutId2 = setTimeout(() => {
					if (repeatCountCheckbox.checked) {
						announceRhythmWithAudio(rhythmString, bpm);
					}else{
						//Clears it, just so we can tell its not runing
						stopRythemCountAnnouncements(); 
					}
				}, currentTime);
				
				//Throw this in the schedual array too, so that the loop can be canceled when anotehr move naration starts
				scheduledRythemClipTimeouts.push(timeoutId2);
			
			}
			
		}
		
		

		
		function playMusic(danceType) {
			if (!musicList[danceType]) return;

			//dont start playing new music if that genre is already playing
			if (currentSongDanceType == danceType && currentSong) return; 

			currentSongDanceType = danceType		

			// Stop the current song if it's playing
			if (currentSong) {
				musicAudio.pause();
			}

			// Get a random song from the selected dance type
			const songs = musicList[danceType];
			

			const filteredSongsByBpmRange = songs.filter(song => {
				return song.bpm >= minBpmVal && song.bpm <= maxBpmVal;
			});

																		//document.getElementById('minBpmVal').min
			const anyBPMRangeAllowed = (minBpmVal == 60 && maxBpmVal == 230);

			if (anyBPMRangeAllowed){
				currentSong = songs[Math.floor(Math.random() * songs.length)];
			}else{
			
				if (filteredSongsByBpmRange.length > 0 ) {
					//Pick random song from songs that match the desired BPM range
					currentSong = filteredSongsByBpmRange[Math.floor(Math.random() * filteredSongsByBpmRange.length)];
				} else {
					console.log("No songs within the specified BPM range.");
					//Just pick a random song normaly without the BPM filter
					currentSong = songs[Math.floor(Math.random() * songs.length)];
				}
			
			}

			musicAudio.src = currentSong.url;
			musicAudio.currentTime = currentSong.startTime || 0; // Default to 0 if no startTime is specified
			if (!isMusicPaused){
				musicAudio.play();
			}
			
			let displaySongTitle = `Now Playing: ${currentSong.title}`;
			// Check if BPM or year is specified and append them in brackets
			if (currentSong.bpm) {
				displaySongTitle += ` (${currentSong.bpm} BPM)`;
				//Auto synk the count BPM setting to match the song
				if (Number.isFinite(currentSong.bpm)) {
					rhythmCountBpmSlider.value = currentSong.bpm; 
					rhythmCountBpmSliderDisplay.textContent = currentSong.bpm;
				}
			}
			if (currentSong.year) {
				displaySongTitle += ` - [${currentSong.year}]`;
			}
			
			currentSongTitle.textContent = displaySongTitle;

			// When the song ends, play the next song
			musicAudio.onended = () => playMusic(danceType);
		}
		
		function playNextSong() {
		
			let danceType = currentSongDanceType;	
			currentSongDanceType = null;			//Sets to null so play music function will let us start a new song
		
		  playMusic(danceType);
		}
		
		
		
		let isMusicPaused = false;

		function toggleMusicPause() {
			if (isMusicPaused) {
				musicAudio.play();
				musicPauseButton.textContent = '‚è∏';
			} else {
				musicAudio.pause();
				musicPauseButton.textContent = '‚èµ';
			}
			isMusicPaused = !isMusicPaused;
		}
		
		
		
		let minBpmVal = 60;
		let maxBpmVal = 230;
		
		noUiSlider.create(document.getElementById("bpmRangeSlider"), {
			start: [60, 230],
			tooltips: [true, true],
			connect: true,
			range: {
				min: 60,
				max: 230
			},
				step: 5,
				format: {
				to: value => Math.round(value),
				from: value => Math.round(value)
			},
			    // Show a scale with the slider
			pips: {
				mode: 'count',
				values: 4
			}
		});

		// Event listener to update BPM range
		document.getElementById("bpmRangeSlider").noUiSlider.on('update', function (values, handle) {
			minBpmVal = parseInt(values[0]);
			maxBpmVal = parseInt(values[1]);
			document.getElementById("bpmRangeDisplay").textContent = `${minBpmVal} - ${maxBpmVal} BPM`;
		});
		
		
		
		
		
		
		
		// Check for Speech Recognition API support
		const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

		if (SpeechRecognition) {
			const recognition = new SpeechRecognition();
			recognition.continuous = true; // Listen continuously
			recognition.lang = "en-US"; // Set language to English
			recognition.interimResults = false; // Only finalize results
			recognition.maxAlternatives = 1; // Use the most confident match

			let isListening = false; // Track microphone state

			// Toggle voice command functionality based on checkbox state
			const voiceCommandCheckbox = document.getElementById("voiceCommandCheckbox");

			voiceCommandCheckbox?.addEventListener("change", () => {
				if (voiceCommandCheckbox.checked) {
					recognition.start();
					console.log("Voice commands enabled. Microphone is listening...");
					isListening = true;
				} else {
					recognition.stop();
					console.log("Voice commands disabled. Microphone stopped listening.");
					isListening = false;
				}
			});

			// Handle recognized speech
			recognition.onresult = (event) => {
				const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
				console.log("Recognized Command:", transcript);

				// Handle voice commands
				if (transcript === "next") {
					generateDanceMove(); // Call function to generate the next move
				} else if (transcript === "help") {
					helpButton.click(); // Simulate help button click
				} else if (transcript === "autodrill" || transcript === "auto drill") {
					autoDrillCheckbox.click(); 
				} else if (transcript === "stop music") {
					if (!isMusicPaused) toggleMusicPause();
				} else if (transcript === "play music") {
					if (!playMusicCheckbox.checked){
						playMusicCheckbox.click();
					}
					if (isMusicPaused) toggleMusicPause();
					
				} else {
					console.log("Unknown command:", transcript);
				}
			};

			// Handle recognition errors
			recognition.onerror = (event) => {
				console.error("Speech Recognition Error:", event.error);
			};

			recognition.onend = () => {
				console.log("Speech Recognition stopped.");
				if (isListening) recognition.start(); // Restart if microphone is still active
			};
		} else {
			console.error("Speech Recognition API not supported in this browser.");
		}

		
		
		
		///------CLAP DETECTION----------
		
		let audioContext;
		let analyser;
		let dataArray;
		let isClapEnabled = false;

		// Threshold for clap detection (adjust for sensitivity)
		const CLAP_THRESHOLD = 0.75;
		const CLAP_DETECTION_DELAY = 600; // Minimum time (ms) between claps

		let lastClapTime = 0;

		function enableClapDetection() {
			navigator.mediaDevices.getUserMedia({ audio: true })
				.then((stream) => {
					audioContext = new AudioContext();
					const source = audioContext.createMediaStreamSource(stream);

					analyser = audioContext.createAnalyser();
					analyser.fftSize = 256; // Smaller size for faster processing
					dataArray = new Uint8Array(analyser.frequencyBinCount);

					source.connect(analyser);

					console.log("Clap detection enabled.");
					isClapEnabled = true;
					listenForClaps();
				})
				.catch((error) => {
					console.error("Error accessing microphone:", error);
				});
		}

		function disableClapDetection() {
			if (audioContext) {
				audioContext.close();
				audioContext = null;
				console.log("Clap detection disabled.");
			}
			isClapEnabled = false;
		}

		function listenForClaps() {
			if (!isClapEnabled) return;

			analyser.getByteTimeDomainData(dataArray);

			// Normalize audio data and calculate average amplitude
			let maxAmplitude = 0;
			for (let i = 0; i < dataArray.length; i++) {
				const normalizedValue = dataArray[i] / 128 - 1; // Normalize to range -1 to 1
				maxAmplitude = Math.max(maxAmplitude, Math.abs(normalizedValue));
			}

			const currentTime = Date.now();
			if (maxAmplitude > CLAP_THRESHOLD && currentTime - lastClapTime > CLAP_DETECTION_DELAY) {
				console.log("Clap detected!");
				lastClapTime = currentTime;

				// Trigger the next move
				generateDanceMove();
			}

			// Continue listening
			requestAnimationFrame(listenForClaps);
		}


		// Add a checkbox to enable/disable clap detection
		document.addEventListener("DOMContentLoaded", () => {
			const clapCheckbox = document.getElementById("clapDetectionCheckbox");
			clapCheckbox.addEventListener("change", (event) => {
				if (event.target.checked) {
					enableClapDetection();
				} else {
					disableClapDetection();
				}
			});
		});

				
		
		
		
		
    </script>
</body>
</html>